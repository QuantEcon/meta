# Code Style Checker Action

This GitHub Action checks Python code style in HTML code-cell blocks using popular Python linters and formatters: flake8, black, and pycodestyle (pep8).

## Features

- Extracts Python code from HTML files (from Jupyter notebook conversions, MyST-NB, etc.)
- Runs configurable style checkers (flake8, black, pep8)
- Provides detailed reports with line numbers and code previews
- Creates GitHub issues and PR comments when issues are found
- Supports artifact generation for detailed reports
- Configurable exclude patterns for common non-lintable code

## Usage

### Basic Usage

```yaml
- name: Check code style
  uses: ./.github/actions/code-style-checker
  with:
    html-path: './_build/html'
```

### Advanced Usage

```yaml
- name: Check code style with custom configuration
  uses: ./.github/actions/code-style-checker
  with:
    html-path: './docs/_build'
    checkers: 'flake8,black'
    max-line-length: '88'
    fail-on-style-issues: 'true'
    create-issue: 'true'
    issue-title: 'Code Style Issues in Documentation'
    create-artifact: 'true'
    notify: 'maintainer1,maintainer2'
    exclude-patterns: '!pip install,plt.show(),# noqa'
```

## Inputs

| Input | Description | Required | Default |
|-------|-------------|----------|---------|
| `html-path` | Path to directory containing HTML files to scan | No | `.` |
| `checkers` | Comma-separated list of style checkers to run (flake8, black, pep8) | No | `flake8,black,pep8` |
| `max-line-length` | Maximum line length for style checks | No | `88` |
| `fail-on-style-issues` | Whether to fail the workflow if style issues are found | No | `true` |
| `create-issue` | Whether to create a GitHub issue when style issues are found | No | `false` |
| `issue-title` | Title for the GitHub issue when style issues are found | No | `Code Style Issues Found in Documentation` |
| `create-artifact` | Whether to create a workflow artifact with the style report | No | `false` |
| `artifact-name` | Name for the workflow artifact containing the style report | No | `code-style-report` |
| `notify` | GitHub username(s) to assign to the created issue (comma-separated) | No | `` |
| `exclude-patterns` | Comma-separated list of code patterns to exclude from checking | No | `!pip install,!conda install,plt.show(),plt.figure(),# noqa` |

## Outputs

| Output | Description |
|--------|-------------|
| `style-issues-found` | Whether style issues were found (true/false) |
| `total-issues` | Total number of style issues found |
| `flake8-issues` | Number of flake8 issues found |
| `black-issues` | Number of black formatting issues found |
| `pep8-issues` | Number of pep8 issues found |
| `style-details` | Details of style issues found |
| `issue-url` | URL of the created GitHub issue (if create-issue is enabled) |
| `artifact-path` | Path to the created artifact file (if create-artifact is enabled) |

## Supported HTML Patterns

The action can detect Python code in various HTML patterns commonly generated by Jupyter notebook conversion tools:

- **Jupyter notebook style**: Elements with classes like `cell_input`, `input_area`
- **MyST-NB style**: Elements with classes like `code-cell`, `language-python`
- **Generic code blocks**: `<pre><code class="python">` or similar patterns
- **Syntax highlighted blocks**: Elements with classes containing `highlight` and `python`

## Code Detection Heuristics

The action uses intelligent heuristics to identify Python code:

- Looks for Python keywords (`import`, `def`, `class`, `if`, `for`, etc.)
- Recognizes common Python libraries (`numpy`, `pandas`, `matplotlib`, etc.)
- Filters out obvious non-Python content (HTML, JavaScript, LaTeX, etc.)
- Cleans up IPython prompts and other notebook artifacts

## Exclude Patterns

Use the `exclude-patterns` input to skip checking certain types of code:

- `!pip install` - Package installation commands
- `plt.show()` - Matplotlib display commands
- `# noqa` - Lines marked to ignore linting
- Custom patterns based on your documentation needs

## Style Checkers

### flake8
- Checks PEP 8 compliance
- Detects syntax errors and logical issues
- Configurable with max line length
- Includes black-compatible ignore rules

### black
- Checks code formatting consistency
- Runs in check mode to detect formatting issues
- Provides diff output for proposed changes
- Respects configured line length

### pycodestyle (pep8)
- Original PEP 8 style checker
- Focuses on style conventions
- Complementary to flake8 checks

## Integration with QuantEcon Style Guide

This action is designed to work with the [QuantEcon Style Guide](../.github/copilot-qe-style-guide.md) and supports:

- Unicode variable names for Greek letters (α, β, γ, etc.)
- Mathematical notation preferences
- QuantEcon-specific coding conventions
- Jupyter notebook best practices

## Examples

### In a Pull Request Workflow

```yaml
name: Code Style Check
on:
  pull_request:
    branches: [ main ]

jobs:
  style-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check code style
        uses: ./.github/actions/code-style-checker
        with:
          html-path: './_build/html'
          fail-on-style-issues: 'true'
          create-issue: 'false'  # Just comment on PR
```

### With Issue Creation for Main Branch

```yaml
name: Weekly Style Check
on:
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9 AM
  workflow_dispatch:

jobs:
  style-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Build documentation
        run: |
          # Your documentation build steps here
          
      - name: Check code style
        uses: ./.github/actions/code-style-checker
        with:
          html-path: './_build/html'
          fail-on-style-issues: 'false'
          create-issue: 'true'
          issue-title: 'Weekly Code Style Report'
          create-artifact: 'true'
          notify: 'maintainer-team'
```

## Troubleshooting

### No Code Blocks Found
- Verify your HTML files contain recognizable code block patterns
- Check that code blocks have appropriate CSS classes
- Use browser dev tools to inspect the HTML structure

### False Positives
- Add problematic patterns to `exclude-patterns`
- Consider if the detected text is actually Python code
- Report edge cases to improve detection heuristics

### Style Checker Errors
- Ensure the code is valid Python syntax
- Check that required dependencies are available
- Review temporary file permissions

## Contributing

To improve code detection or add new style checkers:

1. Modify `style_checker.py` for core functionality
2. Update `format_style_results.py` for new output formats
3. Add test cases to verify behavior
4. Update documentation

## License

This action is part of the QuantEcon meta repository and follows the same license terms.